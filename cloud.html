# Setting up nextcloud on GCP free instance via docker

```bash

# Run nextcloud
docker run -d -p 8080:80  --env NEXTCLOUD_IPADDRESS=34.121.1.150 --env NEXTCLOUD_FQDN=cloud.hakanu.net nextcloud

# take container id
docker ps

# get into docker shell
docker exec -it nervous_wing /bin/bash

```


## Better installation with docker-compose

Source: https://blog.ssdnodes.com/blog/installing-nextcloud-docker/

```bash
sudo apt-get install curl gnupg2 apt-transport-https ca-certificates  software-properties-common

curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"

sudo apt update

sudo apt install docker-ce

sudo systemctl start docker

sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

sudo chmod +x /usr/local/bin/docker-compose

docker-compose --version

# Edit docker-compose.yml
vim docker-compose.yml

sudo docker-compose up -d
```

### Troubleshooting

```bash
#  Could not reliably determine the server's fully qualified domain name, using 172.18.0.5. Set the 'ServerName' directive

sudo docker exec -it nextcloud-app /bin/bash

$ echo "ServerName localhost" >> /etc/apache2/apache2.conf
$ /etc/init.d/apache2 reload
```

Stop all docker containers `sudo docker stop $(sudo docker ps -aq)`

## Manual installation

Best tutorial ever: https://www.howtoforge.com/tutorial/how-to-install-nextcloud-on-debian-10/

Don't even follow below commands.

```bash
sudo apt update
sudo apt install apache2

# Go to localhost:80 or YOUR_VPS_IP:80, you should see default apache2 server page.

# Install php for making apache serve it
sudo apt install php libapache2-mod-php php-mysql

cd /var/www/html
wget https://download.nextcloud.com/server/installer/setup-nextcloud.php

# Go to localhost/setup-nextcloud.php

# If you see you are missing dependencies, do this:
# Install extensions.
sudo apt-get install php7.3-fpm php7.3-gd php7.3-mysql php7.3-curl php7.3-xml php7.3-zip php7.3-intl php7.3-mbstring php7.3-bz2 php7.3-json php-apcu

# If you see error like this about permissions:
# Please fix this by giving the webserver user write access to the directory.
sudo chown -R www-data /var/www/

# Restart apache2 just in case.
sudo systemctl reload apache2

# Set up mariadb
sudo apt install mariadb-server
sudo apt-get install mysql-server mysql-common libmysqlclient-dev mysql-client

# Secure the mariadb setup
sudo mysql_secure_installation

# Create nextcloud user
sudo mysql -u root -p
	CREATE USER 'nextcloud'@'localhost' IDENTIFIED BY 'EmptyWorks';
	CREATE DATABASE IF NOT EXISTS nextcloud;
	GRANT ALL ON nextcloud.* TO 'nextcloud'@'localhost' IDENTIFIED BY 'EmptyWorks';
	FLUSH privileges;

# Now go back to /setup-nextcloud.php and follow the steps,
# make sure you put the exact username and password for mariadb.

# Or go with wget manual installation.
wget https://download.nextcloud.com/server/releases/nextcloud-20.0.0.zip
sudo apt-get install unzip
unzip nextcloud-20.0.0.zip
sudo mv nextcloud /var/www/html/

# Give access
sudo chown -R www-data:www-data /var/www/html/nextcloud/
sudo chmod -R 755 /var/www/html/nextcloud/

# Update PHP
php -v
add-apt-repository ppa:ondrej/php
apt-get update
apt install php7.3 
apt install php7.3-common php7.3-cli php7.3-bz2 php7.3-curl php7.3-gd php7.3-intl php7.3-json php7.3-readline php7.3-xml php7.3-zip php7.3-fpm php7.3-bcmath php7.3-mbstring
sudo apt-get install php7.3-cli php7.3-common php7.3-json php7.3-opcache php7.3-mysql php7.3-mbstring php7.3-zip php7.3-fpm php7.3-intl php7.3-simplexml

a2dismod php7.2
a2enmod php7.3
service apache2 restart
php -v
```